


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AccountAPI</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">server.infrastructure.root.api</a>
</div>

<h1>Coverage Summary for Class: AccountAPI (server.infrastructure.root.api)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AccountAPI</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (15/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    64.4%
  </span>
  <span class="absValue">
    (56/87)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    83%
  </span>
  <span class="absValue">
    (185/223)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AccountAPI$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$1DeleteResult</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$ChangeAuth</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$DeleteAccount</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$Login</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$PasswordReset</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$PasswordResetManager</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (3/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (4/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    69.2%
  </span>
  <span class="absValue">
    (9/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$PrivateUserInfo</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$PublicUserInfo</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (12/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$Register</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$Session</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$UpdateUser</td>
<td class="coverageStat">
  <span class="percent">
    25%
  </span>
  <span class="absValue">
    (1/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    4.2%
  </span>
  <span class="absValue">
    (1/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$UpdateUserFromRequest</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$UserId</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccountAPI$UserInfo</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    72.1%
  </span>
  <span class="absValue">
    (31/43)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    55.7%
  </span>
  <span class="absValue">
    (64/115)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75.8%
  </span>
  <span class="absValue">
    (216/285)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package server.infrastructure.root.api;
&nbsp;
&nbsp;import com.alibaba.fastjson2.JSONReader;
&nbsp;import framework.web.TimedEvents;
&nbsp;import framework.web.WebServer;
&nbsp;import framework.web.annotations.*;
&nbsp;import framework.web.annotations.http.Delete;
&nbsp;import framework.web.annotations.url.Nullable;
&nbsp;import framework.web.request.Request;
&nbsp;import framework.web.route.RouteParameter;
&nbsp;import org.sqlite.SQLiteException;
&nbsp;import framework.db.RoConn;
&nbsp;import framework.db.RoTransaction;
&nbsp;import framework.db.RwTransaction;
&nbsp;import framework.web.error.BadRequest;
&nbsp;import framework.web.error.Unauthorized;
&nbsp;import server.infrastructure.DbManagerImpl;
&nbsp;import server.infrastructure.DynamicMediaHandler;
&nbsp;import server.infrastructure.param.Config;
&nbsp;import server.infrastructure.param.NotRequired;
&nbsp;import server.infrastructure.session.SessionCache;
&nbsp;import server.infrastructure.session.UserSession;
&nbsp;import server.mail.MailServer;
&nbsp;import framework.web.Util;
&nbsp;import framework.web.annotations.url.Path;
&nbsp;import framework.web.param.misc.IpHandler;
&nbsp;import framework.web.param.misc.UserAgentHandler;
&nbsp;import framework.util.SqlSerde;
&nbsp;
&nbsp;import javax.mail.Message;
&nbsp;import java.net.InetAddress;
&nbsp;import java.net.URLEncoder;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.security.SecureRandom;
&nbsp;import java.sql.ResultSet;
&nbsp;import java.sql.SQLException;
&nbsp;import java.util.*;
&nbsp;import java.util.logging.Level;
&nbsp;import java.util.logging.Logger;
&nbsp;
&nbsp;/**
&nbsp; * A group of HTTP API endpoints that provide a suite of user-account-related management operations.
&nbsp; */
&nbsp;@SuppressWarnings(&quot;unused&quot;)
&nbsp;@Routes
<b class="nc">&nbsp;public class AccountAPI {</b>
&nbsp;
&nbsp;    @OnMount
&nbsp;    public static void init(WebServer server){
<b class="nc">&nbsp;        var db = server.getManagedState(DbManagerImpl.class);</b>
&nbsp;
<b class="nc">&nbsp;        var cache = new SessionCache();</b>
<b class="nc">&nbsp;        server.addManagedState(cache);</b>
<b class="nc">&nbsp;        db.addUpdateHook((type, database, table, rowId) -&gt; {</b>
<b class="nc">&nbsp;            if (table.equals(&quot;sessions&quot;)) {</b>
<b class="nc">&nbsp;                switch (type) {</b>
<b class="nc">&nbsp;                    case DELETE, UPDATE -&gt; cache.invalidate_session(rowId);</b>
&nbsp;                    case INSERT -&gt; {
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        var timer = server.getManagedState(TimedEvents.class);</b>
<b class="nc">&nbsp;        timer.addMinutely(() -&gt; {</b>
<b class="nc">&nbsp;            try(var trans = db.rw_transaction(&quot;&gt;session_timer&quot;)){</b>
<b class="nc">&nbsp;                try(var stmt = trans.namedPreparedStatement(&quot;delete from sessions where expiration&lt;:now&quot;)){</b>
<b class="nc">&nbsp;                    stmt.setLong(&quot;:now&quot;, new Date().getTime());</b>
<b class="nc">&nbsp;                    stmt.execute();</b>
&nbsp;                }
<b class="nc">&nbsp;                trans.commit();</b>
<b class="nc">&nbsp;                Logger.getGlobal().log(Level.FINE, &quot;Ran session expiration clear&quot;);</b>
&nbsp;            }catch (Exception e){
<b class="nc">&nbsp;                Logger.getGlobal().log(Level.SEVERE, &quot;Failed to run session expiration clear&quot;, e);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Represents a combination of an email string and a password string.
&nbsp;     */
<b class="fc">&nbsp;    public static class Login{</b>
&nbsp;        public String email;
&nbsp;        public String password;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Logs in a user (if they exist in the users DB table) by creating a session.
&nbsp;     *
&nbsp;     * @return Token of the user&#39;s new session.
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static String login(MailServer mail, @FromRequest(IpHandler.class)InetAddress ip, @FromRequest(UserAgentHandler.class)String agent, RwTransaction trans,  @Body @Json Login login, @Config boolean send_mail_on_login) throws SQLException, Unauthorized {
&nbsp;
&nbsp;        // Check if user exists in user table
&nbsp;        long user_id;
<b class="fc">&nbsp;        login.password = Util.hashy((login.password+&quot;\0\0\0\0&quot;+login.email).getBytes());</b>
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;select id from users where email=:email AND pass=:pass&quot;)){</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:email&quot;, login.email);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:pass&quot;, login.password);</b>
<b class="fc">&nbsp;            try(var res = stmt.executeQuery()){</b>
<b class="fc">&nbsp;                if(!res.next())</b>
<b class="fc">&nbsp;                    throw new Unauthorized(&quot;An account with the specified email does not exist, or the specified password is incorrect&quot;);</b>
&nbsp;                try{
<b class="fc">&nbsp;                    user_id = res.getLong(1);</b>
&nbsp;                }catch (SQLException ignore){
<b class="nc">&nbsp;                    throw new Unauthorized(&quot;An account with the specified email does not exist, or the specified password is incorrect&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Make a new session since at this point they are an existent user.
&nbsp;        long session_id;
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;insert into sessions values(null, null, :user_id, :exp, :agent, :ip) returning id&quot;)){</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:user_id&quot;, user_id);</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:exp&quot;, new Date().getTime() + 2628000000L);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:agent&quot;, agent);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:ip&quot;, ip.getHostAddress());</b>
<b class="fc">&nbsp;            try(var res = stmt.executeQuery()){</b>
<b class="fc">&nbsp;                session_id = res.getLong(1);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Generate token for session
<b class="fc">&nbsp;        var hash = Util.hashy((login.email + &quot;\0\0\0\0&quot; + login.password + &quot;\0\0\0\0&quot; + session_id + &quot;\0\0\0\0&quot; + System.nanoTime()).getBytes());</b>
<b class="fc">&nbsp;        var token = String.format(&quot;%s%08X&quot;, hash, session_id);</b>
&nbsp;
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;update sessions set token=:token where id=:id&quot;)){</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:token&quot;, token);</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:id&quot;, session_id);</b>
<b class="fc">&nbsp;            stmt.execute();</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        trans.commit();</b>
&nbsp;
<b class="fc">&nbsp;        if (send_mail_on_login) {</b>
<b class="fc">&nbsp;            mail.sendMail(message -&gt; {</b>
<b class="fc">&nbsp;                Util.LocationQuery res = null;</b>
&nbsp;                try {
<b class="fc">&nbsp;                    res = Util.queryLocation(ip);</b>
&nbsp;                } catch (Exception ignore) {
&nbsp;                }
<b class="fc">&nbsp;                message.setRecipients(Message.RecipientType.TO, MailServer.fromStrings(login.email));</b>
<b class="fc">&nbsp;                message.setSubject(&quot;Warning&quot;);</b>
&nbsp;
<b class="fc">&nbsp;                message.setContent(&quot;Someone logged into your account &lt;br/&gt;IP: &quot; + ip + &quot;&lt;br/&gt;User Agent: &quot; + agent, &quot;text/html&quot;);</b>
&nbsp;            });
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Logger.getGlobal().log(Level.FINER, &quot;User: &quot; + login.email + &quot; Logged in with session: &quot; + token);</b>
&nbsp;
<b class="fc">&nbsp;        return token;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Represents a record in the &#39;sessions&#39; DB table without the &#39;id&#39; and &#39;token&#39; fields.
&nbsp;     */
<b class="fc">&nbsp;    public static class Session{</b>
&nbsp;        public long id;
&nbsp;        public long expiration;
&nbsp;        public String agent;
&nbsp;        public String ip;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return A list of sessions from the &#39;sessions&#39; DB table, in the form of a {@link List List} of {@link Session Sessions}.
&nbsp;     * @param auth The account that&#39;s doing this
&nbsp;     * @param conn Read-only connection to DB.
&nbsp;     * @throws SQLException
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static @Json List&lt;Session&gt; list_sessions(UserSession auth, RoConn conn) throws SQLException {
&nbsp;        List&lt;Session&gt; result;
<b class="fc">&nbsp;        try(var stmt = conn.namedPreparedStatement(&quot;select * from sessions where user_id=:id&quot;)){</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:id&quot;, auth.user_id());</b>
<b class="fc">&nbsp;            result = SqlSerde.sqlList(stmt.executeQuery(), Session.class);</b>
&nbsp;        }
&nbsp;        conn.close();
<b class="fc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Remove a user session. Only works if session belongs to you and it exists.
&nbsp;     *
&nbsp;     * @param auth The account that&#39;s doing this
&nbsp;     * @param trans The read/write DB transaction this is going to happening in
&nbsp;     * @param session_id The id of the session to invalidate.
&nbsp;     * @throws BadRequest If the session does not belong to you or does not exist.
&nbsp;     * @throws SQLException
&nbsp;     */
&nbsp;    @Route(&quot;/invalidate_session/&lt;session_id&gt;&quot;)
&nbsp;    @Delete
&nbsp;    public static void invalidate_session(UserSession auth, RwTransaction trans, @Path long session_id) throws SQLException, BadRequest {
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;delete from sessions where id=:session_id AND user_id=:user_id&quot;)){</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:session_id&quot;, session_id);</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:user_id&quot;, auth.user_id());</b>
<b class="pc">&nbsp;            if(stmt.executeUpdate() != 1)</b>
<b class="nc">&nbsp;                throw new BadRequest(&quot;Could not invalidate session, session does not belong to you or does not exist&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        trans.commit();</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    public static class DeleteAccount{</b>
&nbsp;        public String email;
&nbsp;        public String password;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Deletes this user&#39;s account (auth and account must be the same account) &lt;br&gt;
&nbsp;     * and removes their profile photo and banner from the media handler.
&nbsp;     *
&nbsp;     * @param auth The account that&#39;s doing this
&nbsp;     * @param trans The read/write DB transaction this is going to happening in
&nbsp;     * @param account The account to be deleted
&nbsp;     * @param media The {@link DynamicMediaHandler} to delete this user&#39;s pfp and banner from
&nbsp;     * @throws Unauthorized If auth and account don&#39;t have the same email
&nbsp;     * @throws SQLException
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static void delete_account(UserSession auth, RwTransaction trans, @Body @Json DeleteAccount account, DynamicMediaHandler media) throws SQLException, Unauthorized {
<b class="fc">&nbsp;        record DeleteResult(long picture, long banner){}</b>
&nbsp;
<b class="pc">&nbsp;        if(!account.email.equals(auth.email()))</b>
<b class="nc">&nbsp;            throw new Unauthorized(&quot;Incorrect email&quot;);</b>
<b class="fc">&nbsp;        account.password = Util.hashy((account.password+&quot;\0\0\0\0&quot;+account.email).getBytes());</b>
&nbsp;
&nbsp;        DeleteResult res;
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;delete from users where email=:email AND pass=:pass returning picture, banner&quot;)){</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:email&quot;, auth.email());</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:pass&quot;, account.password);</b>
<b class="fc">&nbsp;            res = SqlSerde.sqlSingle(stmt.executeQuery(), rs -&gt; new DeleteResult(rs.getLong(&quot;picture&quot;), rs.getLong(&quot;banner&quot;)));</b>
&nbsp;        }
<b class="fc">&nbsp;        trans.commit();</b>
<b class="pc">&nbsp;        if(res.picture!=0)</b>
<b class="fc">&nbsp;            media.delete(res.picture);</b>
<b class="pc">&nbsp;        if(res.banner!=0)</b>
<b class="fc">&nbsp;            media.delete(res.banner);</b>
&nbsp;    }
&nbsp;
&nbsp;    /** Represents an email and/or password change.
&nbsp;     * new_email or new_password can be null if not changing either one.
&nbsp;     */
<b class="fc">&nbsp;    public static class ChangeAuth {</b>
&nbsp;        public String old_email;
&nbsp;        public String new_email;
&nbsp;        public String old_password;
&nbsp;        public String new_password;
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Changes this account&#39;s email and/or password.
&nbsp;     *
&nbsp;     * @param auth The account that&#39;s doing this.
&nbsp;     * @param trans The read/write DB transaction this is going to happening in
&nbsp;     * @param ca The username and/or password change ({@link ChangeAuth})
&nbsp;     * @throws SQLException
&nbsp;     * @throws BadRequest If new username and new password are null.
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static void change_auth(UserSession auth, RwTransaction trans, @Body @Json ChangeAuth ca) throws SQLException, BadRequest {
<b class="pc">&nbsp;        if(ca.new_password==null&amp;&amp;ca.new_email==null)</b>
<b class="nc">&nbsp;            throw new BadRequest(&quot;Nothing to change&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        if(ca.new_password==null)ca.new_password = ca.old_password;</b>
<b class="fc">&nbsp;        if(ca.new_email==null)ca.new_email = ca.old_email;</b>
&nbsp;
<b class="fc">&nbsp;        ca.old_password = Util.hashy((ca.old_password+&quot;\0\0\0\0&quot;+ca.old_email).getBytes());</b>
<b class="fc">&nbsp;        ca.new_password = Util.hashy((ca.new_password+&quot;\0\0\0\0&quot;+ca.new_email).getBytes());</b>
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;update users set pass=:new_password, email=:new_email where email=:old_email AND pass=:old_password AND id=:id&quot;)){</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:old_email&quot;, ca.old_email);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:new_email&quot;, ca.new_email);</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:id&quot;, auth.user_id());</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:old_password&quot;, ca.old_password);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:new_password&quot;, ca.new_password);</b>
<b class="fc">&nbsp;            stmt.execute();</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;delete from sessions where user_id=:id&quot;)){</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:id&quot;, auth.user_id());</b>
<b class="fc">&nbsp;            stmt.execute();</b>
&nbsp;        }
<b class="fc">&nbsp;        trans.commit();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Represents a change to user info such as their name, bio, phone number, and email.
&nbsp;     *
&nbsp;     * This class is designed to support partial updates, meaning the client can provide only the fields they want to change
&nbsp;     * without needing to resend the entire user record.
&nbsp;     */
&nbsp;    @SuppressWarnings(&quot;OptionalUsedAsFieldOrParameterType&quot;)
&nbsp;    public static class UpdateUser{
&nbsp;        public String name;
&nbsp;        public Optional&lt;String&gt; bio;
&nbsp;        public Optional&lt;String&gt; disp_phone_number;
&nbsp;        public Optional&lt;String&gt; disp_email;
&nbsp;
&nbsp;        private static String requireString(JSONReader reader){
<b class="nc">&nbsp;            if(reader.isString())</b>
<b class="nc">&nbsp;                return reader.readString();</b>
&nbsp;            else
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Expected String value&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        private static Optional&lt;String&gt; optionalString(JSONReader reader){
<b class="nc">&nbsp;            if(reader.nextIfNull())</b>
<b class="nc">&nbsp;                return Optional.empty();</b>
<b class="nc">&nbsp;            if(reader.isString())</b>
<b class="nc">&nbsp;                return Optional.of(reader.readString());</b>
&nbsp;            else
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Expected String value&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        public UpdateUser(){}</b>
&nbsp;
&nbsp;        /**
&nbsp;         * @param reader The {@link JSONReader} that gets the new user data
&nbsp;         * @throws BadRequest if the input is malformed
&nbsp;         */
<b class="nc">&nbsp;        public UpdateUser(JSONReader reader) throws BadRequest {</b>
<b class="nc">&nbsp;            if(!reader.nextIfObjectStart())</b>
<b class="nc">&nbsp;                throw new BadRequest(&quot;Expected an object&quot;);</b>
<b class="nc">&nbsp;            while(!reader.nextIfObjectEnd()){</b>
<b class="nc">&nbsp;                if(!reader.isString())</b>
<b class="nc">&nbsp;                    throw new BadRequest(&quot;Expected field&quot;);</b>
<b class="nc">&nbsp;                var field_name = reader.readString();</b>
<b class="nc">&nbsp;                if(!reader.nextIfMatch(&#39;:&#39;))</b>
<b class="nc">&nbsp;                    throw new BadRequest(&quot;Expected colon&quot;);</b>
<b class="nc">&nbsp;                switch(field_name){</b>
<b class="nc">&nbsp;                    case &quot;name&quot; -&gt; this.name = requireString(reader);</b>
<b class="nc">&nbsp;                    case &quot;bio&quot; -&gt; this.bio = optionalString(reader);</b>
<b class="nc">&nbsp;                    case &quot;disp_phone_number&quot; -&gt; this.disp_phone_number = optionalString(reader);</b>
<b class="nc">&nbsp;                    case &quot;disp_email&quot; -&gt; this.disp_email = optionalString(reader);</b>
<b class="nc">&nbsp;                    default -&gt; throw new BadRequest(&quot;Unknown field: &quot; + field_name);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Instantiates a RouteParameter-derived class so that it can parse a {@link UpdateUser} from an HTTP request using {@link FromRequest}
&nbsp;     */
<b class="nc">&nbsp;    public static class UpdateUserFromRequest implements RouteParameter&lt;UpdateUser&gt; {</b>
&nbsp;        @Override
&nbsp;        public UpdateUser construct(Request request) throws Exception {
<b class="nc">&nbsp;            try(var reader = JSONReader.of(request.exchange.getRequestBody().readAllBytes())){</b>
<b class="nc">&nbsp;                return new UpdateUser(reader);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Updates a user&#39;s info (such as name, bio, phone number, and email) in the DB.
&nbsp;     *
&nbsp;     * @param auth The account that&#39;s doing this
&nbsp;     * @param trans The read/write DB transaction this is going to happening in
&nbsp;     * @param update An {@link UpdateUser} type that represents a user info change of any of the following fields: name, bio, disp_phone_number, disp_email
&nbsp;     * @throws SQLException
&nbsp;     * @throws BadRequest If SQL statement failed
&nbsp;     */
&nbsp;    @SuppressWarnings(&quot;OptionalAssignedToNull&quot;)
&nbsp;    @Route
&nbsp;    public static void update_user(UserSession auth, RwTransaction trans, @FromRequest(UpdateUserFromRequest.class) UpdateUser update) throws SQLException, BadRequest {
<b class="fc">&nbsp;        var str = new StringBuilder().append(&quot;update users set &quot;);</b>
&nbsp;
<b class="fc">&nbsp;        if(update.name!=null)</b>
<b class="fc">&nbsp;            str.append(&quot;full_name=:full_name,&quot;);</b>
<b class="fc">&nbsp;        if(update.bio!=null)</b>
<b class="fc">&nbsp;            str.append(&quot;bio=:bio,&quot;);</b>
<b class="fc">&nbsp;        if(update.disp_email!=null)</b>
<b class="fc">&nbsp;            str.append(&quot;disp_email=:disp_email,&quot;);</b>
<b class="fc">&nbsp;        if(update.disp_phone_number!=null)</b>
<b class="fc">&nbsp;            str.append(&quot;disp_phone_number=:disp_phone_number,&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        if(str.charAt(str.length()-1)!=&#39;,&#39;) return;</b>
<b class="fc">&nbsp;        str.deleteCharAt(str.length()-1);</b>
<b class="fc">&nbsp;        str.append(&quot; where id=:id&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(str.toString())){</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:id&quot;, auth.user_id());</b>
&nbsp;
<b class="pc">&nbsp;            if(update.name!=null)</b>
<b class="fc">&nbsp;                stmt.setString(&quot;:full_name&quot;, update.name);</b>
<b class="pc">&nbsp;            if(update.bio!=null&amp;&amp;update.bio.isPresent())</b>
<b class="fc">&nbsp;                stmt.setString(&quot;:bio&quot;, update.bio.get());</b>
<b class="pc">&nbsp;            if(update.disp_email!=null&amp;&amp;update.disp_email.isPresent())</b>
<b class="fc">&nbsp;                stmt.setString(&quot;:disp_email&quot;, update.disp_email.get());</b>
<b class="pc">&nbsp;            if(update.disp_phone_number!=null&amp;&amp;update.disp_phone_number.isPresent())</b>
<b class="fc">&nbsp;                stmt.setString(&quot;:disp_phone_number&quot;, update.disp_phone_number.get());</b>
&nbsp;
<b class="pc">&nbsp;            if(stmt.executeUpdate()!=1)</b>
<b class="nc">&nbsp;                throw new BadRequest(&quot;Failed to update user&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        trans.commit();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * A marker interface to identify classes as containing user information.
&nbsp;     * @see PrivateUserInfo PrivateUserInfo
&nbsp;     * @see PublicUserInfo PublicUserInfo
&nbsp;     */
&nbsp;    public sealed interface UserInfo permits PrivateUserInfo, PublicUserInfo {}
&nbsp;
&nbsp;    /**
&nbsp;     * Represents a user&#39;s public info (including name, bio, phone number, email, pfp, and banner)
&nbsp;     */
<b class="fc">&nbsp;    public record PublicUserInfo(</b>
&nbsp;        long id,
&nbsp;        String name,
&nbsp;        boolean organizer,
&nbsp;        String bio,
&nbsp;        String disp_email,
&nbsp;        String disp_phone_number,
&nbsp;        long picture,
&nbsp;        long banner
&nbsp;    ) implements UserInfo {
&nbsp;        public static PublicUserInfo make(ResultSet rs) throws SQLException {
<b class="fc">&nbsp;            return make(rs, rs.getLong(&quot;id&quot;));</b>
&nbsp;        }
&nbsp;
&nbsp;        public static PublicUserInfo make(ResultSet rs, long id) throws SQLException {
<b class="fc">&nbsp;            var organizer = rs.getBoolean(&quot;organizer&quot;);</b>
<b class="fc">&nbsp;            var disp_email = rs.getString(&quot;disp_email&quot;);</b>
<b class="fc">&nbsp;            if(disp_email==null &amp;&amp; organizer)</b>
<b class="fc">&nbsp;                disp_email = rs.getString(&quot;email&quot;);</b>
<b class="fc">&nbsp;            return new PublicUserInfo(</b>
&nbsp;                    id,
<b class="fc">&nbsp;                    rs.getString(&quot;full_name&quot;),</b>
&nbsp;                    organizer,
<b class="fc">&nbsp;                    rs.getString(&quot;bio&quot;),</b>
&nbsp;                    disp_email,
<b class="fc">&nbsp;                    rs.getString(&quot;disp_phone_number&quot;),</b>
<b class="fc">&nbsp;                    rs.getLong(&quot;picture&quot;),</b>
<b class="fc">&nbsp;                    rs.getLong(&quot;banner&quot;)</b>
&nbsp;            );
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Represents a user&#39;s private and public user info, including all attrs in {@link PublicUserInfo PublicUserInfo}
&nbsp;     * but also with their user id, email, and whether they are an organizer or admin.
&nbsp;     */
<b class="fc">&nbsp;    public record PrivateUserInfo(</b>
&nbsp;        long id,
&nbsp;        String name,
&nbsp;        String email,
&nbsp;        boolean organizer,
&nbsp;        boolean admin,
&nbsp;        String bio,
&nbsp;        String disp_email,
&nbsp;        String disp_phone_number,
&nbsp;        long picture,
&nbsp;        long banner
&nbsp;    ) implements UserInfo {}
&nbsp;
&nbsp;    /**
&nbsp;     * @return User information as a {@link UserInfo} that is customizably parsable and serializable.
&nbsp;     * @param auth The account that&#39;s doing this
&nbsp;     * @param trans The read/write DB transaction this is going to happening in
&nbsp;     * @param id The id of the user to get this info from
&nbsp;     * @throws SQLException
&nbsp;     * @throws Unauthorized
&nbsp;     */
&nbsp;    @Route(&quot;/userinfo/&lt;id&gt;&quot;)
&nbsp;    public static @Json UserInfo userinfo(@NotRequired UserSession auth, RoTransaction trans, @Path @Nullable Long id) throws SQLException, Unauthorized {
&nbsp;        UserInfo result;
<b class="fc">&nbsp;        if(id!=null){</b>
<b class="fc">&nbsp;            try(trans; var stmt = trans.namedPreparedStatement(&quot;select full_name, email, bio, organizer, disp_email, disp_phone_number, picture, banner from users where id=:id&quot;)){</b>
<b class="fc">&nbsp;                stmt.setLong(&quot;:id&quot;, id);</b>
<b class="fc">&nbsp;                var rs = stmt.executeQuery();</b>
<b class="fc">&nbsp;                result = PublicUserInfo.make(rs, id);</b>
&nbsp;            }
<b class="fc">&nbsp;        }else if(auth!=null){</b>
<b class="fc">&nbsp;            try(trans; var stmt = trans.namedPreparedStatement(&quot;select full_name, bio, disp_email, disp_phone_number, picture, banner from users where id=:id&quot;)){</b>
<b class="fc">&nbsp;                stmt.setLong(&quot;:id&quot;, auth.user_id());</b>
<b class="fc">&nbsp;                var rs = stmt.executeQuery();</b>
<b class="fc">&nbsp;                result = new PrivateUserInfo(</b>
<b class="fc">&nbsp;                        auth.user_id(),</b>
<b class="fc">&nbsp;                        rs.getString(&quot;full_name&quot;),</b>
<b class="fc">&nbsp;                        auth.email(),</b>
<b class="fc">&nbsp;                        auth.organizer(),</b>
<b class="fc">&nbsp;                        auth.admin(),</b>
<b class="fc">&nbsp;                        rs.getString(&quot;bio&quot;),</b>
<b class="fc">&nbsp;                        rs.getString(&quot;disp_email&quot;),</b>
<b class="fc">&nbsp;                        rs.getString(&quot;disp_phone_number&quot;),</b>
<b class="fc">&nbsp;                        rs.getLong(&quot;picture&quot;),</b>
<b class="fc">&nbsp;                        rs.getLong(&quot;banner&quot;)</b>
&nbsp;                );
&nbsp;            }
&nbsp;        }else
<b class="fc">&nbsp;            throw new Unauthorized(&quot;No identification present&quot;);</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Represents all the information needed to Register a user (name, email, and password)
&nbsp;     */
<b class="fc">&nbsp;    public static class Register{</b>
&nbsp;        public String name;
&nbsp;        public String email;
&nbsp;        public String password;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Registers a user in the DB.
&nbsp;     *
&nbsp;     * @param mail The {@link MailServer} used to send them mail if send_mail_on_register is specified as true
&nbsp;     * @param trans The read/write DB transaction this is going to happening in
&nbsp;     * @param register A {@link Register Register} type (containe name, email, and password).
&nbsp;     * @param send_mail_on_register Whether to send them a confirmation email of their registration
&nbsp;     * @throws SQLException
&nbsp;     * @throws BadRequest
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static void register(MailServer mail, RwTransaction trans, @Body @Json Register register, @Config boolean send_mail_on_register) throws SQLException, BadRequest {
<b class="fc">&nbsp;        register.password = Util.hashy((register.password+&quot;\0\0\0\0&quot;+register.email).getBytes());</b>
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;insert into users values(null, :full_name, :email, :pass, false, false, null, null, null, null, null)&quot;)){</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:full_name&quot;, register.name);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:email&quot;, register.email);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:pass&quot;, register.password);</b>
<b class="pc">&nbsp;            if(stmt.executeUpdate()!=1)</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Account couldn&#39;t be created&quot;);</b>
&nbsp;        }catch (SQLiteException e){
<b class="pc">&nbsp;            if(e.getResultCode().code==2067){//UNIQUE CONSTRAINTS FAILED</b>
<b class="fc">&nbsp;                throw new BadRequest(&quot;Account with that email already exists&quot;);</b>
&nbsp;            }
&nbsp;            throw e;
&nbsp;        }
<b class="fc">&nbsp;        trans.commit();</b>
&nbsp;
<b class="fc">&nbsp;        if(send_mail_on_register)</b>
<b class="fc">&nbsp;            mail.sendMail(message -&gt; {</b>
<b class="fc">&nbsp;                message.setRecipients(Message.RecipientType.TO, MailServer.fromStrings(register.email));</b>
<b class="fc">&nbsp;                message.setSubject(&quot;Welcome!&quot;);</b>
<b class="fc">&nbsp;                message.setContent(&quot;Thank you for registering for an account &quot; + register.name, &quot;text/html&quot;);</b>
&nbsp;            });
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Sets a user&#39;s profile photo (called &#39;picture&#39; in DB). Also adds this picture to the specified {@link DynamicMediaHandler}.
&nbsp;     *
&nbsp;     * @param session The session that this user is in now
&nbsp;     * @param trans The transaction this is happening in.
&nbsp;     * @param handler the {@link DynamicMediaHandler} that will handle this new image
&nbsp;     * @param data The raw data of the image (must be &lt;= 10 MiB)
&nbsp;     * @return media_id of the newly added image in the dynamic media &#39;handler&#39;
&nbsp;     * @throws SQLException
&nbsp;     * @throws BadRequest If file is too large (&gt; 10 MiB) or DB update failed.
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static long set_user_picture(UserSession session, RwTransaction trans, DynamicMediaHandler handler, @Body byte[] data) throws SQLException, BadRequest {
&nbsp;        // 10 MiB
<b class="pc">&nbsp;        if(data.length &gt; (1&lt;&lt;20)*10){</b>
<b class="nc">&nbsp;            throw new BadRequest(&quot;File too large, maximum file size is 10 MiB&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var media_id = handler.add(data);</b>
<b class="fc">&nbsp;        long old_media = 0;</b>
&nbsp;        try{
<b class="fc">&nbsp;            try(var stmt = trans.namedPreparedStatement(&quot;select picture from users where id=:id&quot;)){</b>
<b class="fc">&nbsp;                stmt.setLong(&quot;:id&quot;, session.user_id());</b>
<b class="fc">&nbsp;                old_media = stmt.executeQuery().getLong(1);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            try(var stmt = trans.namedPreparedStatement(&quot;update users set picture=:picture where id=:id&quot;)){</b>
<b class="fc">&nbsp;                stmt.setLong(&quot;:id&quot;, session.user_id());</b>
<b class="fc">&nbsp;                stmt.setLong(&quot;:picture&quot;, media_id);</b>
<b class="pc">&nbsp;                if(stmt.executeUpdate()!=1)</b>
<b class="nc">&nbsp;                    throw new BadRequest(&quot;Failed to set picture for user&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            trans.commit();</b>
&nbsp;        }catch (Exception e){
<b class="nc">&nbsp;            trans.commit();</b>
<b class="nc">&nbsp;            if(media_id!=0){</b>
<b class="nc">&nbsp;                handler.delete(media_id);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        if(old_media!=0){</b>
<b class="fc">&nbsp;            handler.delete(old_media);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return media_id;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets a user&#39;s profile banner (called &#39;banner&#39; in DB). Also adds this picture to the specified {@link DynamicMediaHandler}.
&nbsp;     *
&nbsp;     * @param session The session that this user is in now
&nbsp;     * @param trans The transaction this is happening in.
&nbsp;     * @param handler the {@link DynamicMediaHandler} that will handle this new image
&nbsp;     * @param data The raw data of the image (must be &lt;= 10 MiB)
&nbsp;     * @return media_id of the newly added image in the dynamic media &#39;handler&#39;
&nbsp;     * @throws SQLException
&nbsp;     * @throws BadRequest If file is too large (&gt; 10 MiB) or DB update failed.
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static long set_user_banner_picture(UserSession session, RwTransaction trans, DynamicMediaHandler handler, @Body byte[] data) throws SQLException, BadRequest {
&nbsp;        // 10 MiB
<b class="pc">&nbsp;        if(data.length &gt; (1&lt;&lt;20)*10){</b>
<b class="nc">&nbsp;            throw new BadRequest(&quot;File too large, maximum file size is 10 MiB&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var media_id = handler.add(data);</b>
<b class="fc">&nbsp;        long old_media = 0;</b>
&nbsp;        try{
<b class="fc">&nbsp;            try(var stmt = trans.namedPreparedStatement(&quot;select banner from users where id=:id&quot;)){</b>
<b class="fc">&nbsp;                stmt.setLong(&quot;:id&quot;, session.user_id());</b>
<b class="fc">&nbsp;                old_media = stmt.executeQuery().getLong(&quot;banner&quot;);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            try(var stmt = trans.namedPreparedStatement(&quot;update users set banner=:banner where id=:id&quot;)){</b>
<b class="fc">&nbsp;                stmt.setLong(&quot;:id&quot;, session.user_id());</b>
<b class="fc">&nbsp;                stmt.setLong(&quot;:banner&quot;, media_id);</b>
<b class="pc">&nbsp;                if(stmt.executeUpdate()!=1)</b>
<b class="nc">&nbsp;                    throw new BadRequest(&quot;Failed to set banner picture for user&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            trans.commit();</b>
&nbsp;        }catch (Exception e){
<b class="nc">&nbsp;            trans.commit();</b>
<b class="nc">&nbsp;            if(media_id!=0){</b>
<b class="nc">&nbsp;                handler.delete(media_id);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        if(old_media!=0){</b>
<b class="fc">&nbsp;            handler.delete(old_media);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return media_id;</b>
&nbsp;    }
&nbsp;
&nbsp;
<b class="fc">&nbsp;    public record UserId(String email, long id){}</b>
<b class="fc">&nbsp;    public static class PasswordResetManager{</b>
<b class="fc">&nbsp;        private HashMap&lt;String, UserId&gt; h1 = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        private HashMap&lt;String, UserId&gt; h2 = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;        public synchronized UserId remove(String token){
<b class="fc">&nbsp;            var res = h1.remove(token);</b>
<b class="fc">&nbsp;            if(res!=null)return res;</b>
<b class="fc">&nbsp;            return h2.remove(token);</b>
&nbsp;        }
&nbsp;        public synchronized boolean put(String token, UserId id){
<b class="pc">&nbsp;            if(h1.containsKey(token) || h2.containsKey(token))return false;</b>
<b class="fc">&nbsp;            h1.put(token, id);</b>
<b class="fc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
&nbsp;        public synchronized void tick(){
<b class="nc">&nbsp;            h2.clear();</b>
<b class="nc">&nbsp;            var tmp = h2;</b>
<b class="nc">&nbsp;            h2 = h1;</b>
<b class="nc">&nbsp;            h1 = tmp;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @OnMount
&nbsp;    public static void init_reset_password_token_store(WebServer server){
<b class="nc">&nbsp;        var timer = server.getManagedState(TimedEvents.class);</b>
<b class="nc">&nbsp;        var prm = new PasswordResetManager();</b>
<b class="nc">&nbsp;        server.addManagedState(prm);</b>
<b class="nc">&nbsp;        timer.addAtRate(prm::tick, 15*60*1000);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Initiates a password reset process by generating a token and sending a reset email to the user.
&nbsp;     *
&nbsp;     * This method checks if a user with the provided email exists in the database, and if so, generates a
&nbsp;     * random token for resetting the user&#39;s password. The token is stored and associated with the user&#39;s
&nbsp;     * email and ID. A reset email is then sent to the user containing a link with the token, allowing them
&nbsp;     * to reset their password.
&nbsp;     *
&nbsp;     * @param mail The {@link MailServer} used to send the password reset email
&nbsp;     * @param trans The read/write DB transaction this is going to happening in
&nbsp;     * @param email The email address of the user requesting a password reset.
&nbsp;     * @param prm The {@link PasswordResetManager PasswordResetManager} used to store and manage the reset token.
&nbsp;     * @param url_root The root URL of the application to construct the password reset link.
&nbsp;     * @throws SQLException if there is an error while querying the database or interacting with SQL.
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static void reset_password(MailServer mail, RoTransaction trans, @Body String email, PasswordResetManager prm, @Config String url_root) throws SQLException {
&nbsp;        long id;
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;select id from users where email=:email&quot;)){</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:email&quot;, email);</b>
<b class="fc">&nbsp;            var ids = SqlSerde.sqlList(stmt.executeQuery(), rs -&gt; rs.getLong(&quot;id&quot;));</b>
<b class="pc">&nbsp;            if(ids.isEmpty())</b>
&nbsp;                return;
<b class="fc">&nbsp;            id = ids.getFirst();</b>
&nbsp;        }
&nbsp;        trans.close();
&nbsp;
<b class="fc">&nbsp;        var userId = new UserId(email, id);</b>
&nbsp;        String rngStr;
&nbsp;        do{
<b class="fc">&nbsp;            var rng = new byte[32];</b>
<b class="fc">&nbsp;            new SecureRandom().nextBytes(rng);</b>
<b class="fc">&nbsp;            rngStr = Util.base64Str(rng);</b>
<b class="pc">&nbsp;        }while(!prm.put(rngStr, userId));</b>
&nbsp;
<b class="fc">&nbsp;        String finalRngStr = rngStr;</b>
<b class="fc">&nbsp;        mail.sendMail(message -&gt; {</b>
<b class="fc">&nbsp;            message.setRecipients(Message.RecipientType.TO, MailServer.fromStrings(email));</b>
<b class="fc">&nbsp;            message.setSubject(&quot;Do you want to reset your password \uD83E\uDD28&quot;);</b>
<b class="fc">&nbsp;            message.setContent(&quot;click this link if you are sure you really really want to reset your password! &lt;a href=\&quot;&quot;+url_root+&quot;/account/reset_password?token=&quot;+ URLEncoder.encode(finalRngStr, StandardCharsets.UTF_8) +&quot;\&quot;&gt;RESET&lt;/a&gt;&quot;, &quot;text/html&quot;);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    public record PasswordReset(String token, String email, String password){}</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Completes the password reset process by validating the provided token and updating the user&#39;s password.
&nbsp;     *
&nbsp;     * This method takes the reset token and new password from the user, validates the token, ensures the
&nbsp;     * email matches the one associated with the token, and if valid, updates the user&#39;s password in the
&nbsp;     * database. It also clears any active sessions associated with the user to force them to log in again.
&nbsp;     *
&nbsp;     * @param mail The {@link MailServer} used to send the password reset email
&nbsp;     * @param trans The read/write DB transaction this is going to happening in
&nbsp;     * @param reset The {@link PasswordReset PasswordReset} object containing the token, email, and new password.
&nbsp;     * @param prm The {@link PasswordResetManager PasswordResetManager} used to validate and remove the reset token.
&nbsp;     * @throws SQLException If there is an error while interacting with the database during password update.
&nbsp;     * @throws BadRequest If the reset token is invalid or the email does not match.
&nbsp;     */
&nbsp;    @Route
&nbsp;    public static void do_reset_password(MailServer mail, RwTransaction trans, @Body @Json PasswordReset reset, PasswordResetManager prm) throws SQLException, BadRequest {
<b class="fc">&nbsp;        var id = prm.remove(reset.token);</b>
<b class="fc">&nbsp;        if(id==null)</b>
<b class="fc">&nbsp;            throw new BadRequest(&quot;Link has expired&quot;);</b>
<b class="fc">&nbsp;        if(!id.email.equals(reset.email))</b>
<b class="fc">&nbsp;            throw new BadRequest(&quot;Email incorrect&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        var password = Util.hashy((reset.password+&quot;\0\0\0\0&quot;+id.email).getBytes());</b>
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;update users set pass=:pass where id=:id AND email=:email&quot;)){</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:pass&quot;, password);</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:id&quot;, id.id);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:email&quot;, id.email);</b>
<b class="pc">&nbsp;            if(stmt.executeUpdate()!=1)</b>
<b class="nc">&nbsp;                throw new BadRequest(&quot;Failed to actually reset password&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        try(var stmt = trans.namedPreparedStatement(&quot;delete from sessions where user_id=:user_id&quot;)){</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:user_id&quot;, id.id);</b>
<b class="fc">&nbsp;            stmt.execute();</b>
&nbsp;        }
<b class="fc">&nbsp;        trans.commit();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-04-27 17:51</div>
</div>
</body>
</html>
