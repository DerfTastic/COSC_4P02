


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PaymentAPI</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">server.infrastructure.root.api</a>
</div>

<h1>Coverage Summary for Class: PaymentAPI (server.infrastructure.root.api)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PaymentAPI</td>
<td class="coverageStat">
  <span class="percent">
    71.4%
  </span>
  <span class="absValue">
    (10/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    65.4%
  </span>
  <span class="absValue">
    (17/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    82.2%
  </span>
  <span class="absValue">
    (97/118)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PaymentAPI$AccountOrganizerUpgrade</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$AccountOrganizerUpgradeReceipt</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$Estimate</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$Order</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$OrderItem</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$PaymentInfo</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$PurchasedTicketId</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$Receipt</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$ReceiptItem</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$Ticket</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentAPI$TicketReceipt</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    81.5%
  </span>
  <span class="absValue">
    (22/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    65.4%
  </span>
  <span class="absValue">
    (17/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    83.2%
  </span>
  <span class="absValue">
    (109/131)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package server.infrastructure.root.api;
&nbsp;
&nbsp;import com.alibaba.fastjson2.JSON;
&nbsp;import com.alibaba.fastjson2.JSONWriter;
&nbsp;import com.alibaba.fastjson2.annotation.JSONType;
&nbsp;import framework.db.RoTransaction;
&nbsp;import framework.db.RwTransaction;
&nbsp;import framework.util.SqlSerde;
&nbsp;import framework.web.Util;
&nbsp;import framework.web.annotations.*;
&nbsp;import framework.web.annotations.url.Path;
&nbsp;import framework.web.error.BadRequest;
&nbsp;import framework.web.error.ClientError;
&nbsp;import org.sqlite.SQLiteErrorCode;
&nbsp;import org.sqlite.SQLiteException;
&nbsp;import server.handlebars.Hbs;
&nbsp;import server.infrastructure.session.SessionCache;
&nbsp;import server.infrastructure.session.UserSession;
&nbsp;import server.mail.MailServer;
&nbsp;
&nbsp;import javax.mail.Message;
&nbsp;import java.io.IOException;
&nbsp;import java.security.SecureRandom;
&nbsp;import java.sql.SQLException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
&nbsp;
&nbsp;@SuppressWarnings(&quot;unused&quot;)
&nbsp;@Routes
<b class="nc">&nbsp;public class PaymentAPI {</b>
&nbsp;
<b class="fc">&nbsp;    public static long Multiplier = 1_000000L;</b>
&nbsp;
<b class="fc">&nbsp;    public record PaymentInfo(</b>
&nbsp;            String name,
&nbsp;            String billing,
&nbsp;            String card,
&nbsp;            String expiration,
&nbsp;            String code
&nbsp;    ) {
&nbsp;    }
&nbsp;
&nbsp;    @JSONType(
&nbsp;            typeKey = &quot;type&quot;,
&nbsp;            seeAlso = {AccountOrganizerUpgrade.class, Ticket.class}
&nbsp;    )
&nbsp;    public sealed interface OrderItem permits AccountOrganizerUpgrade, Ticket {
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @JSONType(typeName = &quot;AccountOrganizerUpgrade&quot;)</b>
<b class="fc">&nbsp;    public record AccountOrganizerUpgrade() implements OrderItem {</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    @JSONType(typeName = &quot;Ticket&quot;)</b>
<b class="fc">&nbsp;    public record Ticket(long id) implements OrderItem {</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    public record Order(</b>
&nbsp;            List&lt;OrderItem&gt; items,
&nbsp;            PaymentInfo payment
&nbsp;    ) {
&nbsp;    }
&nbsp;
&nbsp;    @JSONType(
&nbsp;            typeKey = &quot;type&quot;,
&nbsp;            seeAlso = {AccountOrganizerUpgradeReceipt.class, TicketReceipt.class},
&nbsp;            serializeFeatures = JSONWriter.Feature.WriteClassName
&nbsp;    )
&nbsp;    public sealed interface ReceiptItem permits AccountOrganizerUpgradeReceipt, TicketReceipt {
&nbsp;        long purchase_price();
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    @JSONType(typeName = &quot;AccountOrganizerUpgrade&quot;)</b>
<b class="fc">&nbsp;    public record AccountOrganizerUpgradeReceipt(long purchase_price) implements ReceiptItem {</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    @JSONType(typeName = &quot;Ticket&quot;)</b>
<b class="fc">&nbsp;    public record TicketReceipt(String name, long ticket_id, String event_name, long event_id, long event_date, String organizer_name, String location_name, long purchase_price, PurchasedTicketId id) implements ReceiptItem {</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    public record PurchasedTicketId(long pid, String salt) {</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    public record Receipt(</b>
&nbsp;            long payment_id,
&nbsp;            List&lt;ReceiptItem&gt; items,
&nbsp;            long date,
&nbsp;            long subtotal,
&nbsp;            long fees,
&nbsp;            long gst,
&nbsp;            long total
&nbsp;    ) {
&nbsp;    }
&nbsp;
&nbsp;    public static void verify_payment(PaymentInfo payment, long amount) throws ClientError {
<b class="pc">&nbsp;        if(amount&gt;500*Multiplier)throw new ClientError(406, &quot;Insufficient Funds&quot;);</b>
<b class="pc">&nbsp;        if(payment.name==null||payment.name.toLowerCase().startsWith(&quot;parker&quot;)) throw new ClientError(406, &quot;Incorrect Card Information&quot;);</b>
<b class="pc">&nbsp;        if(payment.card==null||payment.card.startsWith(&quot;3&quot;)) throw new ClientError(406, &quot;Unrecognized Card&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Route(&quot;/get_receipt/&lt;receipt_id&gt;&quot;)
&nbsp;    public static @Json Receipt get_receipt(UserSession auth, RoTransaction trans, @Path int receipt_id) throws SQLException {
&nbsp;        Receipt res;
<b class="nc">&nbsp;        try (var stmt = trans.namedPreparedStatement(&quot;select * from payments where user_id=:user_id AND id=:receipt_id order by payment_date desc&quot;)) {</b>
<b class="nc">&nbsp;            stmt.setLong(&quot;:user_id&quot;, auth.user_id());</b>
<b class="nc">&nbsp;            stmt.setLong(&quot;:receipt_id&quot;, receipt_id);</b>
<b class="nc">&nbsp;            res = SqlSerde.sqlSingle(stmt.executeQuery(), rs -&gt; new Receipt(</b>
<b class="nc">&nbsp;                    rs.getLong(&quot;id&quot;),</b>
<b class="nc">&nbsp;                    JSON.parseArray(rs.getString(&quot;receipt&quot;), ReceiptItem.class),</b>
<b class="nc">&nbsp;                    rs.getLong(&quot;payment_date&quot;),</b>
<b class="nc">&nbsp;                    rs.getLong(&quot;subtotal&quot;),</b>
<b class="nc">&nbsp;                    rs.getLong(&quot;fees&quot;),</b>
<b class="nc">&nbsp;                    rs.getLong(&quot;gst&quot;),</b>
<b class="nc">&nbsp;                    rs.getLong(&quot;total&quot;)</b>
&nbsp;            ));
&nbsp;        }
<b class="nc">&nbsp;        trans.commit();</b>
<b class="nc">&nbsp;        return res;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Route
&nbsp;    public static @Json List&lt;Receipt&gt; list_receipts(UserSession auth, RoTransaction trans) throws SQLException {
&nbsp;        List&lt;Receipt&gt; list;
<b class="fc">&nbsp;        try (var stmt = trans.namedPreparedStatement(&quot;select * from payments where user_id=:user_id order by payment_date desc&quot;)) {</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:user_id&quot;, auth.user_id());</b>
<b class="fc">&nbsp;            list = SqlSerde.sqlList(stmt.executeQuery(), rs -&gt; new Receipt(</b>
<b class="fc">&nbsp;                    rs.getLong(&quot;id&quot;),</b>
<b class="fc">&nbsp;                    JSON.parseArray(rs.getString(&quot;receipt&quot;), ReceiptItem.class),</b>
<b class="fc">&nbsp;                    rs.getLong(&quot;payment_date&quot;),</b>
<b class="fc">&nbsp;                    rs.getLong(&quot;subtotal&quot;),</b>
<b class="fc">&nbsp;                    rs.getLong(&quot;fees&quot;),</b>
<b class="fc">&nbsp;                    rs.getLong(&quot;gst&quot;),</b>
<b class="fc">&nbsp;                    rs.getLong(&quot;total&quot;)</b>
&nbsp;            ));
&nbsp;        }
<b class="fc">&nbsp;        trans.commit();</b>
<b class="fc">&nbsp;        return list;</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    public record Estimate(</b>
&nbsp;            List&lt;ReceiptItem&gt; items,
&nbsp;            long subtotal,
&nbsp;            long fees,
&nbsp;            long gst,
&nbsp;            long total
&nbsp;    ) {
&nbsp;    }
&nbsp;
&nbsp;    @Route
&nbsp;    public static @Json Estimate create_estimate(UserSession auth, RoTransaction trans, @Body @Json OrderItem[] order) throws SQLException {
<b class="fc">&nbsp;        ArrayList&lt;ReceiptItem&gt; items = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        long subtotal = 0;</b>
<b class="fc">&nbsp;        try (var ticket = trans.namedPreparedStatement(&quot;&quot;&quot;</b>
&nbsp;            select
&nbsp;                name,
&nbsp;                (select name from events where id=event_id),
&nbsp;                event_id,
&nbsp;                (select start from events where id=event_id),
&nbsp;                (select location_name from events where id=event_id),
&nbsp;                (select full_name from users where id IN (select owner_id from events where id=event_id)),
&nbsp;                price
&nbsp;            from tickets where
&nbsp;                id=:ticket_id AND event_id IN (select id from events where draft=false)
&nbsp;            &quot;&quot;&quot;)) {
<b class="fc">&nbsp;            for (var item : order) {</b>
<b class="pc">&nbsp;                switch (item) {</b>
<b class="fc">&nbsp;                    case AccountOrganizerUpgrade ignore -&gt; items.add(new AccountOrganizerUpgradeReceipt(50_000000));</b>
<b class="fc">&nbsp;                    case Ticket(long id) -&gt; {</b>
<b class="fc">&nbsp;                        ticket.setLong(&quot;:ticket_id&quot;, id);</b>
<b class="fc">&nbsp;                        items.add(SqlSerde.sqlSingle(ticket.executeQuery(),</b>
<b class="fc">&nbsp;                                rs -&gt; new TicketReceipt(</b>
<b class="fc">&nbsp;                                        rs.getString(1),</b>
&nbsp;                                        id,
<b class="fc">&nbsp;                                        rs.getString(2),</b>
<b class="fc">&nbsp;                                        rs.getLong(3),</b>
<b class="fc">&nbsp;                                        rs.getLong(4),</b>
<b class="fc">&nbsp;                                        rs.getString(5),</b>
<b class="fc">&nbsp;                                        rs.getString(6),</b>
<b class="fc">&nbsp;                                        rs.getLong(7),</b>
&nbsp;                                        null
&nbsp;                                ))
&nbsp;                        );
&nbsp;                    }
&nbsp;                }
<b class="fc">&nbsp;                subtotal += items.getLast().purchase_price();</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        long fees = (subtotal * 15000) / Multiplier; // 0.015 1.5%</b>
<b class="fc">&nbsp;        long gst = (subtotal * 50000) / Multiplier; // 0.050 5.0%</b>
<b class="fc">&nbsp;        long total = subtotal + fees + gst;</b>
<b class="fc">&nbsp;        trans.commit();</b>
&nbsp;
<b class="fc">&nbsp;        return new Estimate(</b>
&nbsp;                items,
&nbsp;                subtotal,
&nbsp;                fees,
&nbsp;                gst,
&nbsp;                total
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    @Route
&nbsp;    public static @Json Receipt make_purchase(UserSession auth, RwTransaction trans, @Body @Json Order order, SessionCache cache, MailServer mail) throws SQLException, ClientError {
&nbsp;
<b class="fc">&nbsp;        long date = System.currentTimeMillis();</b>
&nbsp;        long payment_id;
<b class="fc">&nbsp;        try (var stmt = trans.namedPreparedStatement(&quot;insert into payments values (null, :user_id, &#39;&#39;, :date, 0, 0, 0, 0) returning id&quot;)) {</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:user_id&quot;, auth.user_id());</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:date&quot;, date);</b>
<b class="fc">&nbsp;            payment_id = SqlSerde.sqlSingle(stmt.executeQuery(), rs -&gt; rs.getLong(&quot;id&quot;));</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        ArrayList&lt;ReceiptItem&gt; items = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        long subtotal = 0;</b>
<b class="fc">&nbsp;        try (var ticket = trans.namedPreparedStatement(&quot;&quot;&quot;</b>
&nbsp;                        insert into purchased_tickets values
&nbsp;                            (null, :user_id, :ticket_id, :payment_id, (select price from tickets where id=:ticket_id), :salt)
&nbsp;                        returning
&nbsp;                            (select name from tickets where id=:ticket_id),
&nbsp;                            (select name from events where id IN (select event_id from tickets where id=:ticket_id)),
&nbsp;                            (select event_id from tickets where id=:ticket_id),
&nbsp;                            (select start from events where id IN (select event_id from tickets where id=:ticket_id)),
&nbsp;                            (select name from events where id IN (select event_id from tickets where id=:ticket_id)),
&nbsp;                            (select full_name from users where id IN (select owner_id from events where id IN (select event_id from tickets where id=:ticket_id))),
&nbsp;                            (select price from tickets where id=:ticket_id),
&nbsp;                            id
&nbsp;                        &quot;&quot;&quot;);
<b class="fc">&nbsp;             var organizer = trans.namedPreparedStatement(</b>
&nbsp;                     &quot;update users set organizer=true where id=:user_id&quot;)
&nbsp;            ) {
<b class="fc">&nbsp;            for (var item : order.items) {</b>
<b class="pc">&nbsp;                switch (item) {</b>
<b class="fc">&nbsp;                    case AccountOrganizerUpgrade ignore -&gt; {</b>
<b class="fc">&nbsp;                        organizer.setLong(&quot;:user_id&quot;, auth.user_id());</b>
<b class="pc">&nbsp;                        if (organizer.executeUpdate() != 1)</b>
<b class="nc">&nbsp;                            throw new SQLException();</b>
<b class="fc">&nbsp;                        items.add(new AccountOrganizerUpgradeReceipt(50_000000));</b>
&nbsp;
<b class="pc">&nbsp;                        if (cache != null) {</b>
&nbsp;                            // we need to manually invalidate the cache here
<b class="nc">&nbsp;                            try (var stmt = trans.namedPreparedStatement(&quot;select id from sessions where user_id=:id&quot;)) {</b>
<b class="nc">&nbsp;                                stmt.setLong(&quot;:id&quot;, auth.user_id());</b>
<b class="nc">&nbsp;                                SqlSerde.sqlForEach(stmt.executeQuery(), rs -&gt; {</b>
<b class="nc">&nbsp;                                    cache.invalidate_session(rs.getLong(&quot;id&quot;));</b>
&nbsp;                                });
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
<b class="fc">&nbsp;                    case Ticket(long id) -&gt; {</b>
<b class="fc">&nbsp;                        ticket.setLong(&quot;:user_id&quot;, auth.user_id());</b>
<b class="fc">&nbsp;                        ticket.setLong(&quot;:ticket_id&quot;, id);</b>
<b class="fc">&nbsp;                        ticket.setLong(&quot;:payment_id&quot;, payment_id);</b>
<b class="fc">&nbsp;                        var rng = new byte[16];</b>
<b class="fc">&nbsp;                        new SecureRandom().nextBytes(rng);</b>
<b class="fc">&nbsp;                        var salt = Util.hashy(rng);</b>
<b class="fc">&nbsp;                        ticket.setString(&quot;:salt&quot;, salt);</b>
<b class="fc">&nbsp;                        items.add(SqlSerde.sqlSingle(ticket.executeQuery(),</b>
<b class="fc">&nbsp;                                rs -&gt; new TicketReceipt(</b>
<b class="fc">&nbsp;                                        rs.getString(1),</b>
&nbsp;                                        id,
<b class="fc">&nbsp;                                        rs.getString(2),</b>
<b class="fc">&nbsp;                                        rs.getLong(3),</b>
<b class="fc">&nbsp;                                        rs.getLong(4),</b>
<b class="fc">&nbsp;                                        rs.getString(5),</b>
<b class="fc">&nbsp;                                        rs.getString(6),</b>
<b class="fc">&nbsp;                                        rs.getLong(7),</b>
<b class="fc">&nbsp;                                        new PurchasedTicketId(rs.getLong(8), salt)</b>
&nbsp;                                )));
&nbsp;                    }
&nbsp;                }
<b class="fc">&nbsp;                subtotal += items.getLast().purchase_price();</b>
&nbsp;            }
&nbsp;        }catch (SQLiteException e){
<b class="pc">&nbsp;            if (e.getResultCode() == SQLiteErrorCode.SQLITE_CONSTRAINT_TRIGGER){</b>
<b class="fc">&nbsp;                var msg = e.getMessage().split(&quot;\\(&quot;)[1];</b>
<b class="fc">&nbsp;                throw new BadRequest(msg.substring(0, msg.length()-1));</b>
&nbsp;            }
&nbsp;            throw e;
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        long fees = (subtotal * 15000) / Multiplier; // 0.015 1.5%</b>
<b class="fc">&nbsp;        long gst = (subtotal * 50000) / Multiplier; // 0.050 5.0%</b>
<b class="fc">&nbsp;        long total = subtotal + fees + gst;</b>
<b class="fc">&nbsp;        try (var stmt = trans.namedPreparedStatement(&quot;update payments set receipt=:receipt, subtotal=:subtotal, fees=:fees, gst=:gst, total=:total where id=:payment_id&quot;)) {</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:payment_id&quot;, payment_id);</b>
<b class="fc">&nbsp;            stmt.setString(&quot;:receipt&quot;, JSON.toJSONString(items));</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:subtotal&quot;, subtotal);</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:fees&quot;, fees);</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:gst&quot;, gst);</b>
<b class="fc">&nbsp;            stmt.setLong(&quot;:total&quot;, total);</b>
<b class="pc">&nbsp;            if (stmt.executeUpdate() != 1)</b>
<b class="nc">&nbsp;                throw new SQLException();</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var receipt = new Receipt(</b>
&nbsp;                payment_id,
&nbsp;                items,
&nbsp;                date,
&nbsp;                subtotal,
&nbsp;                fees,
&nbsp;                gst,
&nbsp;                total
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        verify_payment(order.payment, total);</b>
<b class="fc">&nbsp;        trans.commit();</b>
&nbsp;
<b class="fc">&nbsp;        mail.sendMail(message -&gt; {</b>
<b class="fc">&nbsp;            message.setRecipients(Message.RecipientType.TO, MailServer.fromStrings(auth.email()));</b>
<b class="fc">&nbsp;            message.setSubject(&quot;Purchase&quot;);</b>
&nbsp;
&nbsp;            try {
<b class="fc">&nbsp;                message.setContent(Hbs.run(&quot;email_receipt&quot;, receipt), &quot;text/html&quot;);</b>
&nbsp;            } catch (IOException e) {
<b class="nc">&nbsp;                throw new RuntimeException(e);</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="fc">&nbsp;        return receipt;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String formatPrice(long price) {
<b class="fc">&nbsp;        return &quot;$&quot; + (price / 1000000) + &quot;.&quot; + String.format(&quot;%06d&quot;, price % 1000000);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-04-27 17:51</div>
</div>
</body>
</html>
